#!/usr/bin/php
<?php

	$departments = array();
	$orgchart = json_decode(file_get_contents("http://data.southampton.ac.uk/dumps/org/2014-07-01/org.json"), true);
	foreach($orgchart as $org)
	{
		foreach($org["suborganisations"] as $sub_org)
		{
			if(array_key_exists("finance_code", $sub_org))
			{
				$departments[$sub_org["finance_code"]] = $sub_org;
				$departments[$sub_org["finance_code"]]["parent"] = $org;
				
			}
		}
		if("F4" == @$org["finance_code"])
		{
			$departments["KW"]["parent"] = $org;

		}
		if("F1" == @$org["finance_code"])
		{
			$departments["TR"]["parent"] = $org;
		}

		#admin staff are in department which has the same department code as faculty code...
		if(preg_match('/^F\d/',@$org["finance_code"])){
			$departments[@$org["finance_code"]] = @$org;
			$departments[@$org["finance_code"]]["parent"] = @$org;
		}
	}

	file_put_contents(__DIR__."/../var/departments.php", serialize($departments));
